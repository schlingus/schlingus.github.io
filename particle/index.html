<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>schlingus' particle simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000;
            color: #e5e7eb;
            font-family: system-ui, -apple-system, sans-serif;
        }
        canvas {
            display: block;
            touch-action: none;
        }
        .panel {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        input[type="range"] {
            accent-color: #3b82f6;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Combined UI Overlay -->
    <div class="fixed top-4 left-4 z-50 flex flex-col gap-4 max-w-xs w-full">
        <div class="panel p-5 rounded-2xl shadow-2xl">
            <h1 class="text-xl font-bold mb-1 text-white">schlingus' particle simulation</h1>
            <p class="text-[10px] text-gray-400 mb-4 uppercase tracking-widest">
                dont put density too high, its not worth it
            </p>
            
            <div class="space-y-4">
                <!-- Density - Scaled up to 100 Million -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <label>dot density</label>
                        <span id="count-val">800</span>
                    </div>
                    <input type="range" id="particle-count" min="100" max="100000000000" step="1000" value="800" class="w-full">
                </div>

                <!-- Pull Power -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <label>pull power</label>
                        <span id="strength-val">1.8</span>
                    </div>
                    <input type="range" id="strength-slider" min="0.1" max="100" step="0.5" value="1.8" class="w-full">
                </div>

                <!-- Avoidance -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <label>personal space (Avoidance)</label>
                        <span id="avoid-val">1.2</span>
                    </div>
                    <input type="range" id="avoid-strength" min="0.1" max="5.0" step="0.1" value="1.2" class="w-full">
                </div>

                <!-- Friction -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <label>drift (momentum)</label>
                        <span id="friction-val">0.96</span>
                    </div>
                    <input type="range" id="friction-input" min="0.80" max="0.999" step="0.001" value="0.96" class="w-full">
                </div>

                <!-- Glow Toggle -->
                <div class="flex items-center justify-between">
                    <label class="text-sm">glow intensity</label>
                    <div class="flex gap-2">
                        <button id="glow-off" class="px-3 py-1 bg-gray-800 rounded text-[10px]">OFF</button>
                        <button id="glow-on" class="px-3 py-1 bg-blue-600 rounded text-[10px] font-bold">HIGH</button>
                    </div>
                </div>

                <div class="pt-2 border-t border-white/10 flex flex-wrap gap-2">
                    <button id="reset-btn" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg text-xs font-medium transition">Reset</button>
                    <button id="explode-btn" class="bg-purple-600 hover:bg-purple-500 px-3 py-1.5 rounded-lg text-xs font-medium transition">Supernova</button>
                </div>
            </div>
        </div>
        
        <div id="perf-warning" class="hidden panel p-3 rounded-xl text-[10px] text-amber-400 border-amber-500/30 animate-pulse">
            extreme density, fps saver on üëç
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        
        const config = {
            particleCount: 800,
            friction: 0.96,
            mouseStrength: 1.8,
            glowEnabled: true,
            universalAvoidance: 1.2,
            avoidRadius: 15,
            chaseStrength: 0.5
        };

        let particles = [];
        let width, height;
        let mouse = { x: -1000, y: -1000, active: false };

        class Particle {
            constructor() {
                this.init();
            }

            init() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 5;
                this.vy = (Math.random() - 0.5) * 5;
                
                const rand = Math.random();
                if (rand < 0.05) {
                    this.color = '#4ade80'; // Green
                } else if (rand < 0.52) {
                    this.color = '#ef4444'; // Red
                } else {
                    this.color = '#3b82f6'; // Blue
                }
                
                // Shrink dots as density increases
                this.radius = config.particleCount > 50000 ? 0.8 : 2.5;
            }

            update() {
                if (mouse.active) {
                    const dx = mouse.x - this.x;
                    const dy = mouse.y - this.y;
                    const dSq = dx * dx + dy * dy;
                    if (dSq > 1) {
                        const dist = Math.sqrt(dSq);
                        this.vx += (dx / dist) * config.mouseStrength;
                        this.vy += (dy / dist) * config.mouseStrength;
                    }
                }

                // Optimization: Disable expensive avoidance/AI at very high counts
                if (config.particleCount < 100000000000000000000000000000000000000000000000000000000) {
                    this.applyAvoidance();
                }

                this.vx *= config.friction;
                this.vy *= config.friction;
                this.x += this.vx;
                this.y += this.vy;

                if (this.x < 0) this.x = width;
                else if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                else if (this.y > height) this.y = 0;
            }

            applyAvoidance() {
                const step = Math.max(1, Math.floor(particles.length / 50));
                for (let i = 0; i < particles.length; i += step) {
                    const other = particles[i];
                    if (other === this) continue;
                    const dx = this.x - other.x;
                    const dy = this.y - other.y;
                    const distSq = dx * dx + dy * dy;
                    if (distSq < config.avoidRadius * config.avoidRadius && distSq > 0.1) {
                        const dist = Math.sqrt(distSq);
                        const force = (config.avoidRadius - dist) / config.avoidRadius;
                        this.vx += (dx / dist) * force * config.universalAvoidance;
                        this.vy += (dy / dist) * force * config.universalAvoidance;
                    }
                }
            }

            draw() {
                ctx.fillStyle = this.color;
                if (config.particleCount > 5000) {
                    // Use fillRect for high performance drawing
                    ctx.fillRect(this.x, this.y, this.radius, this.radius);
                } else {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            initParticles();
        }

        function initParticles() {
            particles = [];
            // Cap at 1 million for browser safety regardless of slider
            const count = Math.min(config.particleCount, 100000000000); 
            for (let i = 0; i < count; i++) {
                particles.push(new Particle());
            }
            const warning = document.getElementById('perf-warning');
            config.particleCount > 10000 ? warning.classList.remove('hidden') : warning.classList.add('hidden');
        }

        function animate() {
            ctx.fillStyle = config.glowEnabled ? 'rgba(0, 0, 0, 0.2)' : '#000000';
            ctx.fillRect(0, 0, width, height);

            if (config.glowEnabled) ctx.globalCompositeOperation = 'lighter';

            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
            }

            ctx.globalCompositeOperation = 'source-over';
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', resize);
        window.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });
        window.addEventListener('mousedown', () => mouse.active = true);
        window.addEventListener('mouseup', () => mouse.active = false);

        document.getElementById('particle-count').addEventListener('input', (e) => {
            config.particleCount = parseInt(e.target.value);
            document.getElementById('count-val').innerText = config.particleCount.toLocaleString();
            initParticles();
        });

        document.getElementById('strength-slider').addEventListener('input', (e) => {
            config.mouseStrength = parseFloat(e.target.value);
            document.getElementById('strength-val').innerText = config.mouseStrength;
        });

        document.getElementById('avoid-strength').addEventListener('input', (e) => {
            config.universalAvoidance = parseFloat(e.target.value);
            document.getElementById('avoid-val').innerText = config.universalAvoidance.toFixed(1);
        });

        document.getElementById('friction-input').addEventListener('input', (e) => {
            config.friction = parseFloat(e.target.value);
            document.getElementById('friction-val').innerText = config.friction.toFixed(3);
        });

        document.getElementById('glow-on').addEventListener('click', () => {
            config.glowEnabled = true;
            document.getElementById('glow-on').classList.add('bg-blue-600', 'font-bold');
            document.getElementById('glow-off').classList.remove('bg-blue-600', 'font-bold');
        });

        document.getElementById('glow-off').addEventListener('click', () => {
            config.glowEnabled = false;
            document.getElementById('glow-off').classList.add('bg-blue-600', 'font-bold');
            document.getElementById('glow-on').classList.remove('bg-blue-600', 'font-bold');
        });

        document.getElementById('reset-btn').addEventListener('click', initParticles);
        document.getElementById('explode-btn').addEventListener('click', () => {
            particles.forEach(p => {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 30 + 10;
                p.vx = Math.cos(angle) * speed;
                p.vy = Math.sin(angle) * speed;
            });
        });

        resize();
        animate();
    </script>
</body>
</html>
